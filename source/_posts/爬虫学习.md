---
title: 爬虫学习
date: 2020-08-20T10:10:57.000Z
updated: '2024-07-01 20:38:14'
categories:
  - Python
tags:
  - Python
---

## 浏览器抓包
就是前端基础知识，包括

1. HTTP 的请求方式：如 get post方法
2. 请求头 了解一下 Request Header 
   1. 如 Accept、Host、cookie、User-Agent
3. 服务器的**响应**

请求方式->请求参数->请求头定义->怎么拿到返回的数据

## requsets
```shell
pip install requests
```
```python
import requests

#get请求
r = requests.get('url')

#get请求带参数
payload = {'key1': 'value1', 'key2': 'value2'}
r = requests.get('https://httpbin.org/get', params=payload)

#post请求
r = requests.post('url', data = {'key':'value'})
#请求的时候用json 作为参数
payload = {'some': 'data'}
r = requests.post(url, json=payload)

#假装自己是浏览器
url = 'url'
headers = {'user-agent': 'my-app/0.0.1'}
r = requests.get(url, headers=headers)

#获取服务器响应文本内容
r = requests.get('https://api.github.com/events')
r.text
#字节响应内容
r.content
#响应码
r.status_code
#获取响应头
r.headers
#{    
#    'content-encoding': 'gzip',    
#    'transfer-encoding': 'chunked',  
#    'connection': 'close',    
#    'server': 'nginx/1.0.4',    
#    'x-runtime': '148ms',    
#    'etag': '"e1ca502697e5c9317743dc078f67693f"',   
#    'content-type': 'application/json'
#}

#Json 响应内容
r.json()
#socket 流响应内容

#获取 cookie 信息
 r.cookies['example_cookie_name']
#发送 cookie 信息
cookies = dict(cookies_are='working')
r = requests.get(url, cookies=cookies)
r.text

```

### 一个例子
```python
import requests
import re
import json


#获取请求文本，因为所需要的内容就在文本里
def request_dandan(url):
    try:
        response = requests.get(url)
        if response.status_code == 200:
            return response.text
    except requests.RequestException as e:
        print(e)
        return None

#正则提取
def parse_result(html):
    pattern = re.compile(
        '<li.*?list_num.*?(\d+)\.</div>.*?<img src="(.*?)".*?class="name".*?title="(.*?)">.*?class="star">.*?class="tuijian">(.*?)</span>.*?class="publisher_info">.*?target="_blank">(.*?)</a>.*?class="biaosheng">.*?<span>(.*?)</span></div>.*?<p><span class="price_n">(.*?)</span>.*?</li>', re.S)
    items = re.findall(pattern, html)

    #封装数据
    for item in items:
        yield {
            'range': item[0],
            'image': item[1],
            'title': item[2],
            'recommend': item[3],
            'author': item[4],
            'times': item[5],
            'price': item[6]
        }

#文件读入
def write_item_to_file(item):
    print('开始写入数据 ====> ' + str(item))
    with open('book.txt', 'a', encoding='UTF-8') as f:
        f.write(json.dumps(item, ensure_ascii=False) + '\n')

#每页请求
def main(page):
    url = 'http://bang.dangdang.com/books/fivestars/01.00.00.00.00.00-recent30-0-0-1-' + str(page) + str(page)
    html = request_dandan(url)
    items = parse_result(html)  # 解析过滤我们想要的信息
    for item in items:
        write_item_to_file(item)

#26页 for 循环
if __name__ == "__main__":
    for i in range(1, 26):
        main(i)

```

### beautifulsoup4
```python
pip install beautifulsoup4
#参考文档
#https://www.crummy.com/software/BeautifulSoup/bs4/doc/
```

### 第2个case Excel +bs4
```python
import requests
from bs4 import BeautifulSoup
import xlwt


def request_douban(url):
    # 请求头
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) '
                      'Chrome/88.0.4324.146 Safari/537.36',
    }
    # 返回文本内容
    try:
        response = requests.get(url=url, headers=headers)
        if response.status_code == 200:
            return response.text
    except requests.RequestException:
        return None


# excel 格式
book = xlwt.Workbook(encoding='utf-8', style_compression=0)

sheet = book.add_sheet('豆瓣电影Top250', cell_overwrite_ok=True)
sheet.write(0, 0, '名称')
sheet.write(0, 1, '图片')
sheet.write(0, 2, '排名')
sheet.write(0, 3, '评分')
sheet.write(0, 4, '作者')
sheet.write(0, 5, '简介')

n = 1

# excel 保存


def save_to_excel(soup):
    list = soup.find(class_='grid_view').find_all('li')

    for item in list:
        item_name = item.find(class_='title').string
        item_img = item.find('a').find('img').get('src')
        item_index = item.find(class_='').string
        item_score = item.find(class_='rating_num').string
        item_author = item.find('p').text
        if item.find(class_='inq') is not None:
            item_intr = item.find(class_='inq').string
        else:
            item_intr = 'NOT AVAILABLE'

        # print('爬取电影：' + item_index + ' | ' + item_name +' | ' + item_img +' | ' + item_score +' | ' + item_author +' | ' + item_intr )
        print('爬取电影：' + item_index + ' | ' + item_name +
              ' | ' + item_score + ' | ' + item_intr)

        global n

        sheet.write(n, 0, item_name)
        sheet.write(n, 1, item_img)
        sheet.write(n, 2, item_index)
        sheet.write(n, 3, item_score)
        sheet.write(n, 4, item_author)
        sheet.write(n, 5, item_intr)

        n = n + 1


def main(page):
    url = 'https://movie.douban.com/top250?start=' + \
        str(page * 25) + '&filter='
    html = request_douban(url)
    soup = BeautifulSoup(html, 'lxml')
    save_to_excel(soup)


if __name__ == '__main__':

    for i in range(0, 10):
        main(i)

book.save(u'豆瓣最受欢迎的250部电影.xlsx')
```

## selenium
> 自动化测试工具

```python
pip install selenium
```
浏览器驱动下载
chrome ：[https://sites.google.com/a/chromium.org/chromedriver/downloads](https://sites.google.com/a/chromium.org/chromedriver/downloads)
**需要在path里添加驱动的环境变量**
参考文档 ：[https://selenium-python.readthedocs.io/](https://selenium-python.readthedocs.io/)

### selenium + phantomjs
> 对于市面上大多通过 js 渲染的动态网站，难以解析的网站
> 想要爬取的话，就会使用到


## 多线程
> 常用的多线程的模块有这么几个
> _thread
> threading
> Queue

```python
# encoding = utf-8
import concurrent
import os
from concurrent.futures import ThreadPoolExecutor
import requests
from bs4 import BeautifulSoup


def header(referer):

    headers = {
        'Host': 'i.meizitu.net',
        'Pragma': 'no-cache',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.8,en;q=0.6',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36',
        'Accept': 'image/webp,image/apng,image/*,*/*;q=0.8',
        'Referer': '{}'.format(referer),
    }

    return headers


def request_page(url):
    try:
        response = requests.get(url)
        if response.status_code == 200:
            return response.text
    except requests.RequestException:
        return None


def get_page_urls():

    for i in range(1, 2):
        baseurl = 'https://www.mzitu.com/page/{}'.format(i)
        html = request_page(baseurl)
        soup = BeautifulSoup(html, 'lxml')
        elements = soup.find(class_='postlist').find_all('li')
        urls = []
        for item in elements:
            url = item.find('span').find('a').get('href')
            print('页面链接：%s' % url)
            urls.append(url)

    return urls


def download_Pic(title, image_list):
    # 新建文件夹
    os.mkdir(title)
    j = 1
    # 下载图片
    for item in image_list:
        filename = '%s/%s.jpg' % (title, str(j))
        print('downloading....%s : NO.%s' % (title, str(j)))
        with open(filename, 'wb') as f:
            img = requests.get(item, headers=header(item)).content
            f.write(img)
        j += 1

def download(url):
    html = request_page(url)
    soup = BeautifulSoup(html, 'lxml')
    total = soup.find(class_='pagenavi').find_all('a')[-2].find('span').string
    title = soup.find('h2').string
    image_list = []

    for i in range(int(total)):
        html = request_page(url + '/%s' % (i + 1))
        soup = BeautifulSoup(html, 'lxml')
        img_url = soup.find('img').get('src')
        image_list.append(img_url)

    download_Pic(title, image_list)


def download_all_images(list_page_urls):
    # 获取每一个详情妹纸
    # works = len(list_page_urls)
    with concurrent.futures.ProcessPoolExecutor(max_workers=5) as exector:
        for url in list_page_urls:
            exector.submit(download, url)


if __name__ == '__main__':
    # 获取每一页的链接和名称
    list_page_urls = get_page_urls()
    download_all_images(list_page_urls)
```

## 视频真实地址解析参考 
> [https://www.cnblogs.com/williamweson/p/13583880.html](https://www.cnblogs.com/williamweson/p/13583880.html)
> 学习地址：[https://github.com/wistbean/learn_python3_spider](https://github.com/wistbean/learn_python3_spider)

